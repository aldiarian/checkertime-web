var tiempoEspera=2500,tiempoInicio=0,storage=window.localStorage,dominio="https://checkertime.elojografico.net",cambioObligado=!1,app={initialize:function(){document.addEventListener("deviceready",this.onDeviceReady,!1),tiempoInicio=Date.now()},onDeviceReady:function(){$menuLateral=$(".menu-lateral"),$(".icono-menu--abrir").on("click",function(){$menuLateral.addClass("abrir-menu")}),$(".icono-menu--cerrar").on("click",function(){$menuLateral.removeClass("abrir-menu")}),$innerHeight=window.innerHeight,$innerWidth=window.innerWidth,$("#loginButton").on("click",app.handleLogin),$("#botonDesconectar").on("click",app.desconectar),$("#botonSalir").on("click",app.salir);var e=setInterval(app.actualizarHora,1e3);document.addEventListener("backbutton",function(e){e.preventDefault(),navigator.app.exitApp()},!1),$("#botonSalir").click(function(e){e.preventDefault(),navigator.app.exitApp()}),$("#login-fecha").dateDropper({}),$("#login-hora").timeDropper({format:"HH:mm"}),app.checkLogged()},desconectar:function(e){e.preventDefault(),app.limpiarStorage(),$menuLateral.removeClass("abrir-menu"),$(":mobile-pagecontainer").pagecontainer("change","#pageLogin")},salir:function(e){e.preventDefault(),navigator.app.exitApp()},actualizarHora:function(){var e=new Date,a=e.getFullYear().toString(),o=("0"+(e.getMonth()+1)).slice(-2),t=("0"+e.getDate()).slice(-2),i=("0"+e.getHours()).slice(-2),n=("0"+e.getMinutes()).slice(-2),r=("0"+e.getSeconds()).slice(-2),s=t+"/"+o+"/"+a,d=i+":"+n+":"+r;$("#mainfecha").html(s),$("#mainhora").html(d)},limpiarStorage:function(){storage.removeItem("empresa"),storage.removeItem("dni"),storage.removeItem("razon"),storage.removeItem("nombre"),storage.removeItem("token"),storage.removeItem("geolocalizar"),storage.removeItem("manuales"),storage.removeItem("estado")},cambiaPagina:function(e){$menuLateral.removeClass("abrir-menu"),$(":mobile-pagecontainer").pagecontainer("change",e)},refrescaBotones:function(e){2!=e&&0!=e||($("#fichar_entrada").removeClass("deshabilitado"),$("#fichar_entrada").removeClass("fichado"),$("#fichar_salida").addClass("deshabilitado"),$("#fichar_salida").removeClass("fichado"),$("#fichar_entra_descanso").addClass("deshabilitado"),$("#fichar_entra_descanso").removeClass("fichado"),$("#fichar_fin_descanso").addClass("deshabilitado"),$("#fichar_fin_descanso").removeClass("fichado")),1!=e&&4!=e||($("#fichar_entrada").removeClass("deshabilitado"),$("#fichar_entrada").addClass("fichado"),$("#fichar_salida").removeClass("deshabilitado"),$("#fichar_salida").removeClass("fichado"),$("#fichar_entra_descanso").removeClass("deshabilitado"),$("#fichar_entra_descanso").removeClass("fichado"),$("#fichar_fin_descanso").addClass("deshabilitado"),$("#fichar_fin_descanso").removeClass("fichado")),3==e&&($("#fichar_entrada").removeClass("deshabilitado"),$("#fichar_entrada").addClass("fichado"),$("#fichar_salida").addClass("deshabilitado"),$("#fichar_salida").removeClass("fichado"),$("#fichar_entra_descanso").removeClass("deshabilitado"),$("#fichar_entra_descanso").addClass("fichado"),$("#fichar_fin_descanso").addClass("deshabilitado"),$("#fichar_fin_descanso").removeClass("fichado")),app.addSliders()},addSliders:function(){$("#slider_entrada").off("touchmove"),$("#slider_entrada").off("touchend"),$("#slider_entrada").parent().hasClass("deshabilitado")||$("#slider_entrada").parent().hasClass("fichado")||($("#slider_entrada").on("touchmove",app.moveSlider),$("#slider_entrada").on("touchend",app.stopSlider)),$("#slider_salida").off("touchmove"),$("#slider_salida").off("touchend"),$("#slider_salida").parent().hasClass("deshabilitado")||$("#slider_salida").parent().hasClass("fichado")||($("#slider_salida").on("touchmove",app.moveSlider),$("#slider_salida").on("touchend",app.stopSlider)),$("#slider_entra_descanso").off("touchmove"),$("#slider_entra_descanso").off("touchend"),$("#slider_entra_descanso").parent().hasClass("deshabilitado")||$("#slider_entra_descanso").parent().hasClass("fichado")||($("#slider_entra_descanso").on("touchmove",app.moveSlider),$("#slider_entra_descanso").on("touchend",app.stopSlider)),$("#slider_fin_descanso").off("touchmove"),$("#slider_fin_descanso").off("touchend"),$("#slider_fin_descanso").parent().hasClass("deshabilitado")||$("#slider_fin_descanso").parent().hasClass("fichado")||($("#slider_fin_descanso").on("touchmove",app.moveSlider),$("#slider_fin_descanso").on("touchend",app.stopSlider))},moveSlider:function(e){e.preventDefault();var a=$(this).parent().width()-80,o=e.originalEvent.touches[0];curX=o.pageX-this.offsetLeft-73,curX<=0||(curX>a?(this.style.webkitTransform="translateX("+a+"px)",this.style.left="inherit",$(this).parent().find(".texto_fichado").html($(this).data("tipoevento")),$(this).parent().addClass("fichado"),$(this).off("touchmove")):this.style.webkitTransform="translateX("+curX+"px)")},stopSlider:function(e){this.addEventListener("webkitTransitionEnd",app.transition,!1),this.style.webkitTransition="-webkit-transform 0.1s ease-in",$(this).parent().hasClass("fichado")?$(this).off("touchend"):this.style.webkitTransform="translateX(0px)"},transition:function(){this.removeEventListener("webkitTransitionEnd",app.transition,!1),this.style.webkitTransition="none"},checkLogged:function(){if(void 0==storage.getItem("empresa")||void 0==storage.getItem("dni")||void 0==storage.getItem("token")){var e=tiempoEspera-(Date.now()-tiempoInicio);e>0?setTimeout(function(){$(":mobile-pagecontainer").pagecontainer("change","#pageLogin")},e):$(":mobile-pagecontainer").pagecontainer("change","#pageLogin")}else{var a=storage.getItem("empresa"),o=storage.getItem("dni"),t=storage.getItem("token");$.ajax({url:dominio+"/services/services.php",data:{referrer:"EOG_CT_App",action:"checklogin",empresa:a,dni:o,token:t},cache:!1,type:"POST",dataType:"json"}).done(function(e){var t="#pageLogin";e.resultado&&($("#resempresa").html(storage.getItem("razon")),$("#resempresa2").html(storage.getItem("razon")),$("#resnombre").html(storage.getItem("nombre")),$("#resnombre2").html(storage.getItem("nombre")),storage.setItem("empresa",a),storage.setItem("dni",o),storage.setItem("razon",e.razon),storage.setItem("nombre",e.nombre),storage.setItem("token",e.token),storage.setItem("geolocalizar",e.geolocalizar),storage.setItem("manuales",e.manuales),storage.setItem("estado",e.estado),0==e.tieneemail?$("#enlaceOlvidoContrasena").hide():$("#enlaceOlvidoContrasena").show(),0==e.manuales?$("#fichado_manual").hide():$("#fichado_manual").show(),app.refrescaBotones(e.estado),1==e.changepass?(cambioObligado=!0,$("#menu-cambio").hide(),$("#atras-cambio").hide(),$("#grupo-cambio-obligado").show(),$("#grupo-cambio-no-obligado").hide(),t="#pageCambiarContrasena"):(cambioObligado=!1,$("#menu-cambio").show(),$("#atras-cambio").show(),$("#grupo-cambio-obligado").hide(),$("#grupo-cambio-no-obligado").show(),t="#pageFichar"));var i=tiempoEspera-(Date.now()-tiempoInicio);i>0?setTimeout(function(){$(":mobile-pagecontainer").pagecontainer("change",t)},i):$(":mobile-pagecontainer").pagecontainer("change",t)}).fail(function(e,a,o){navigator.app.exitApp()})}},handleLogin:function(){$("#loginButton").attr("disabled","disabled");var e=$("#login-empresa").val(),a=$("#login-numeroId").val(),o=$("#login-contrasena").val(),t=device.platform;return""!=e&&""!=a&&""!=o?$.ajax({url:dominio+"/services/services.php",data:{referrer:"EOG_CT_App",action:"login",empresa:e,dni:a,password:sha256(o),plataforma:t},cache:!1,type:"POST",dataType:"json"}).done(function(o){if(o.resultado===!1)navigator.notification.alert("Credenciales incorrectas",function(){});else{var t="#pageFichar";storage.setItem("empresa",e),storage.setItem("dni",a),storage.setItem("razon",o.razon),storage.setItem("nombre",o.nombre),storage.setItem("token",o.token),storage.setItem("geolocalizar",o.geolocalizar),storage.setItem("manuales",o.manuales),storage.setItem("estado",o.estado),1==o.changepass?(cambioObligado=!0,$("#menu-cambio").hide(),$("#atras-cambio").hide(),$("#grupo-cambio-obligado").show(),$("#grupo-cambio-no-obligado").hide(),t="#pageCambiarContrasena"):(cambioObligado=!1,$("#menu-cambio").show(),$("#atras-cambio").show(),$("#grupo-cambio-obligado").hide(),$("#grupo-cambio-no-obligado").show(),t="#pageFichar"),$("#resempresa").html(o.razon),$("#resempresa2").html(o.razon),$("#resnombre").html(o.nombre),$("#resnombre2").html(o.nombre),$("#login-empresa").val(""),$("#login-numeroId").val(""),$("#login-contrasena").val(""),0==o.tieneemail?$("#enlaceOlvidoContrasena").hide():$("#enlaceOlvidoContrasena").show(),0==o.manuales?$("#fichado_manual").hide():$("#fichado_manual").show(),app.refrescaBotones(o.estado),$(":mobile-pagecontainer").pagecontainer("change",t)}$("#loginButton").removeAttr("disabled")}).fail(function(e,a,o){$("#loginButton").removeAttr("disabled")}):(navigator.notification.alert("Debe rellenar los datos",function(){}),$("#loginButton").removeAttr("disabled")),!1},fichar:function(e,a){$("#ficharButton1").button("disable"),$("#ficharButton2").button("disable"),$("#ficharButton3").button("disable"),$("#ficharButton4").button("disable"),$("#ficharButton4").button("refresh");var o=storage.getItem("empresa"),t=storage.getItem("dni"),i=storage.getItem("token"),n=storage.getItem("geolocalizar"),r=new Date,s=r.getFullYear().toString(),d=("0"+(r.getMonth()+1)).slice(-2),c=("0"+r.getDate()).slice(-2),l=("0"+r.getHours()).slice(-2),m=("0"+r.getMinutes()).slice(-2),h=("0"+r.getSeconds()).slice(-2),g=s+"-"+d+"-"+c+" "+l+":"+m+":"+h,p=c+"/"+d+"/"+s,f=l+":"+m+":"+h,u=0,b=0;1==n?navigator.geolocation.getCurrentPosition(function(n){u=n.coords.latitude,b=n.coords.longitude,enviarEvento(o,t,i,g,u,b,e,a,p,f)},function(n){u=0,b=0,enviarEvento(o,t,i,g,u,b,e,a,p,f)},{maximumAge:3e4,timeout:5e3,enableHighAccuracy:!0}):enviarEvento(o,t,i,g,u,b,e,a,p,f)},enviarEvento:function(e,a,o,t,i,n,r,s,d,c){$.ajax({url:dominio+"/services/services.php",data:{referrer:"EOG_CT_App",action:"fichar",empresa:e,dni:a,token:o,fecha:t,latitud:i,longitud:n,manual:r,evento:s},cache:!1,type:"POST",dataType:"json"}).done(function(e){if(e.resultado===!1)navigator.notification.alert("Error al fichar",function(){},"Alerta");else{var a="";switch(s){case 1:a="ENTRADA";break;case 2:a="SALIDA";break;case 3:a="INICIO DESCANSO";break;case 4:a="FIN DESCANSO"}navigator.notification.alert("Fichado correctamente como "+a+", el día "+d+", a las "+c+".",function(){},"Todo correcto"),storage.setItem("estado",s)}refrescaBotones(s)}).fail(function(e,a,o){s=storage.getItem("estado"),refrescaBotones(s)})}};$(document).ready(function(){app.initialize()});